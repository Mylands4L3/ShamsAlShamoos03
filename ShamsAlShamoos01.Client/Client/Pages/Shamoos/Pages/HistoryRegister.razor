@page "/history-register"
@layout ShamsAlShamoos01.Client.Client.Pages.Shamoos.Shared.MainLayout
@inject NavigationManager Nav
@inject HttpClient Http
@inject HistoryRegisterService HistoryService
<PageTitle>ثبت فاکتور - شمس الشموس</PageTitle>

<!-- Meta tags برای SEO -->
<HeadContent>
    <meta name="description" content="صفحه ثبت فاکتور شمس الشموس. ایجاد و مدیریت فاکتورها و مشاهده QR کد مربوطه.">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</HeadContent>

<div class="container mt-4">

    <h1 class="fw-bold mb-4 text-center">📋 جدول ثبت فاکتور</h1>

    <!-- بخش تولید QR -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-8 col-12">
                    <input class="form-control form-control-lg"
                           @bind="Value"
                           @bind:event="oninput"
                           placeholder="متن یا عدد"
                           aria-label="متن یا عدد برای QR" />
                </div>
                <div class="col-md-4 col-12 d-grid">
                    <button class="btn btn-success btn-lg" @onclick="Generate" disabled="@IsGenerating" aria-busy="@IsGenerating">
                        @if (IsGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>در حال ساخت...</span>
                        }
                        else
                        {
                            <span>ساخت QR</span>
                        }
                    </button>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(ImageUrl))
            {
                <div class="text-center mt-4">
                    <img src="@ImageUrl"
                         class="img-fluid rounded shadow-sm"
                         style="max-width: 250px;"
                         alt="QR Code فاکتور" />
                </div>
            }
        </div>
    </div>

    <!-- جدول داده‌ها -->
    @if (IsLoading)
    {
        <p class="text-center my-5">در حال بارگذاری داده‌ها...</p>
    }
    else if (GridData == null || !GridData.Any())
    {
        <p class="text-center my-5">هیچ داده‌ای موجود نیست.</p>
    }
    else
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body p-2 p-md-3">
                <SfGrid DataSource="@GridData"
                        AllowPaging="true"
                        AllowSorting="true"
                        AllowFiltering="true"
                        Height="auto"
                        EnableRtl="true"
                        CssClass="bm-grid"
                        Toolbar="@(new List<string>() { "Search" })"
                        Width="100%">

                    <GridSelectionSettings CheckboxOnly="true"
                                           PersistSelection="true"
                                           Type="Syncfusion.Blazor.Grids.SelectionType.Multiple" />
                    <GridPageSettings PageCount="5" PageSize="10" PageSizes="@PageSizeOptions" />
                    <GridTextWrapSettings WrapMode="WrapMode.Content"></GridTextWrapSettings>
                    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel" />

                    <GridColumns>
                        <GridColumn Field="HistoryRegisterKala01ID" HeaderText="شناسه" Width="100" TextAlign="TextAlign.Center" AllowFiltering="true" Type="ColumnType.String"></GridColumn>
                        <GridColumn Field="DocumentNO01" HeaderText="شماره سند" Width="150" TextAlign="TextAlign.Center" AllowFiltering="true" Type="ColumnType.String"></GridColumn>
                        <GridColumn Field="Vartext01" HeaderText="توضیحات" Width="200" TextAlign="TextAlign.Right" AllowFiltering="true" Type="ColumnType.String"></GridColumn>
                    </GridColumns>

                </SfGrid>
            </div>
        </div>
    }
</div>

@code {
    private object[] PageSizeOptions = new object[] { 5, 10, 20, 50, "All" };
    private bool IsLoading = true;
    private bool IsGenerating = false;

    private List<HistoryRegisterKala01ViewModel_Update> GridData = new();
    public string ImageUrl { get; set; }
    public string Value { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            GridData = await HistoryService.LoadDataAsync("12345") ?? new List<HistoryRegisterKala01ViewModel_Update>();
        }
        catch
        {
            GridData = new List<HistoryRegisterKala01ViewModel_Update>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Generate()
    {
        if (string.IsNullOrWhiteSpace(Value)) return;

        IsGenerating = true;
        try
        {
            string fileName = await Http.GetStringAsync($"api/Qr/Generate?text={Value}");
            ImageUrl = $"{Http.BaseAddress}QrFiles/{fileName}.png";
        }
        catch
        {
            ImageUrl = null;
        }
        finally
        {
            IsGenerating = false;
        }
    }
}
