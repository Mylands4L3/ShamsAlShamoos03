@page "/CreateQRFromtxt02"
@inject HttpClient Http

<h2 class="text-center">📦 نمایش QRهای موجود و متن داخل آنها</h2>

<button class="btn btn-primary mb-4" disabled="@IsLoading" @onclick="LoadExistingQRCodes">
    @if (IsLoading)
    {
        <span class="spinner-border spinner-border-sm me-2"></span>
        <span> در حال بارگذاری...</span >



        }
    else
    {
        <span>بارگذاری QRها</span>
    }
</button>

@if (QrFiles?.Count > 0)
{
    <div class="row g-4">
        @foreach (var qr in QrFiles)
        {
            <div class="col-md-3 col-sm-4 col-6 text-center">
                <div class="p-2 border rounded shadow-sm">
                    <img src="@($"{Http.BaseAddress}QrFiles/{qr.RelativePath}")"
                         class="img-fluid rounded" alt="QR Code" />
                    <div class="fw-bold mt-2">@qr.FileName</div>
                    <div class="text-muted mt-1">@QrTexts.GetValueOrDefault(qr.RelativePath)</div>
                </div>
            </div>
        }
    </div>
}
@code {
    public bool IsLoading { get; set; } = false;
    public List<QrFileDto> QrFiles { get; set; } = new();
    public Dictionary<string, string> QrTexts { get; set; } = new();

    private async Task LoadExistingQRCodes()
    {
        IsLoading = true;
        QrFiles.Clear();
        QrTexts.Clear();

        try
        {
            // تغییر به List<QrFileDto>
            var files = await Http.GetFromJsonAsync<List<QrFileDto>>("api/Qr/GetAllFiles");

            if (files != null && files.Count > 0)
            {
                QrFiles = files;

                // خواندن متن QRها
                var tasks = QrFiles.Select(async qr =>
                {
                    try
                    {
                        var text = await Http.GetStringAsync($"api/Qr/ReadQr?relativePath={qr.RelativePath}");
                        QrTexts[qr.RelativePath] = text;
                    }
                    catch
                    {
                        QrTexts[qr.RelativePath] = "خواندن متن QR ناموفق بود";
                    }
                });

                await Task.WhenAll(tasks);
            }
        }
        finally
        {
            IsLoading = false;
        }
    }
}
